<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> flask按钮触发 · Persuing</title><meta name="description" content="flask按钮触发 - Persuing"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://Persuingsdu.github.io/atom.xml" title="Persuing"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">flask按钮触发</h1><div class="post-info">Jun 6, 2018</div><div class="post-content"><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css"><h2 id="利用-Ajax-执行事件"><a href="#利用-Ajax-执行事件" class="headerlink" title="利用 Ajax 执行事件"></a>利用 Ajax 执行事件</h2><p>在写课设的时候，遇到一个问题，点击按钮，触发事件，向数据库中写入新发表的评论。<br>那么怎么做呢？需要使用Ajax来进行.对这个问题花了很多时间，终于得到解决，方案如下：<br><figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line">  &lt;script&gt;</div><div class="line">  &lt;!-- javascript代码 --&gt;</div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> txt=<span class="built_in">document</span>.getElementById(<span class="string">'comment'</span>).value;</div><div class="line">  <span class="keyword">var</span> data = &#123;<span class="string">"comment"</span>:txt,<span class="string">"isbn"</span>:&#123;&#123; isbn &#125;&#125; &#125;;</div><div class="line">  $.ajax(&#123;</div><div class="line">      type: <span class="string">'POST'</span>,</div><div class="line">      contentType: <span class="string">'application/json'</span>,</div><div class="line">      url: <span class="string">'/test'</span>,</div><div class="line">      dataType : <span class="string">'json'</span>,</div><div class="line">      data : <span class="built_in">JSON</span>.stringify(data),</div><div class="line">      success : <span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</div><div class="line">          jQuery(<span class="string">"#clash"</span>).html(result);</div><div class="line">      &#125;,<span class="attr">error</span> : <span class="function"><span class="keyword">function</span>(<span class="params">result</span>)</span>&#123;</div><div class="line">          <span class="built_in">console</span>.log(result);</div><div class="line">      &#125;</div><div class="line">  &#125;);</div><div class="line">&#125;</div><div class="line">&lt;<span class="regexp">/script&gt;</span></div></pre></td></tr></table></figure></p>
<p>其中<code>url</code>是我们设置的路由，提交POST请求，Ajax的写法<a href="https://stackoverflow.com/questions/29091070/how-to-get-data-from-immutablemultidict-in-flask" target="_blank" rel="external">参考如下</a><br>按钮的写法，点击按钮，调用<code>test()</code>函数<br><figure class="highlight html"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">class</span>=<span class="string">"btn btn-outline-primary"</span> <span class="attr">onclick</span>=<span class="string">"test()"</span>&gt;</span>发表评论<span class="tag">&lt;/<span class="name">button</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>路由的写法：<br><figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="string">'''</span></div><div class="line"><span class="string">进行发表评论 </span></div><div class="line"><span class="string">添加进数据库</span></div><div class="line"><span class="string">'''</span></div><div class="line"><span class="meta">@main.route('/test',methods=['POST'])</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></div><div class="line">    jsonData = request.get_json()</div><div class="line">    id = BookComment.query.count() + <span class="number">1</span></div><div class="line">    ISBN=str(jsonData[<span class="string">'isbn'</span>])</div><div class="line">    comment=jsonData[<span class="string">'comment'</span>]</div><div class="line">    bookcomment = BookComment(id=id, ISBN=ISBN, comment=comment)</div><div class="line">    db.session.add(bookcomment)</div><div class="line">    db.session.commit()</div><div class="line">    <span class="keyword">return</span> <span class="string">'ok'</span><span class="comment">#任意值</span></div></pre></td></tr></table></figure></p>
<p>以上便可以解决类似的问题，ajax方面还需要学习。</p>
<h2 id="利用-DOM-previousSibling-属性-进行删除"><a href="#利用-DOM-previousSibling-属性-进行删除" class="headerlink" title="利用 DOM previousSibling 属性 进行删除"></a>利用 DOM previousSibling 属性 进行删除</h2><p>短评模块，从数据库中选取出该书的相关评论（评论来源豆瓣读书），并利用<code>jinja2</code>进行渲染。<br><figure class="highlight html"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"list-group"</span>&gt;</span></div><div class="line">      &#123;% for c in comments %&#125;</div><div class="line">          <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"list-group-item"</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123; c.comment &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">"display:none;"</span>&gt;</span>&#123;&#123; c.id &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span>&#123;% if current_user.is_admin() %&#125;<span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">class</span>=<span class="string">"btn btn-outline-primary"</span> <span class="attr">onclick</span>=<span class="string">"d(this)"</span> <span class="attr">data-toggle</span>=<span class="string">"modal"</span> <span class="attr">data-target</span>=<span class="string">"#del"</span>&gt;</span>删除<span class="tag">&lt;/<span class="name">button</span>&gt;</span>&#123;% endif %&#125;</div><div class="line">          <span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">      &#123;% endfor %&#125;</div><div class="line"> <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>管理员有权限对评论进行删除，在评论的后面，加了一个删除按钮，只有在所登陆的用户为管理员时，方可见，并进行相应的删除操作。那么利用<code>jinja2</code>渲染出来的评论如何进行删除呢？<br><img src="/img/shuping.png" alt="shuping"><br>一开始的设想是：对评论加一个id，然后进行<code>DOM</code>提取，但是，经过<code>jinja1</code>渲染出来后的评论拥有多个相同的<code>id</code>，<br>显然，这是不合适的。<br>那么，如何确定所要删除的评论是哪一条呢？利用删除按钮进行操作，点击删除按钮，执行函数<code>d(h)</code>,<br><code>onclick=&quot;d(this)&quot;</code>。然后在利用<code>previousSibling</code>提取出，该按钮节点之前的<code>评论id</code>节点，获取其数据库中的位置，进行删除。需要注意的是，利用previousSibling该节点和上一个节点之间不能有空格。<br><code>d(h)</code>如下<br><figure class="highlight javascript"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">d</span>(<span class="params">h</span>)</span>&#123;</div><div class="line">   <span class="keyword">var</span> text=h.previousSibling.innerHTML</div><div class="line">   <span class="keyword">var</span> data = &#123;<span class="string">"id"</span>:text&#125;;</div><div class="line">   $.ajax(&#123;</div><div class="line">      type: <span class="string">'POST'</span>,</div><div class="line">      contentType: <span class="string">'application/json'</span>,</div><div class="line">      url: <span class="string">'/d'</span>,</div><div class="line">      dataType : <span class="string">'json'</span>,</div><div class="line">      data : <span class="built_in">JSON</span>.stringify(data),</div><div class="line">      success : <span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</div><div class="line">        jQuery(<span class="string">"#clash"</span>).html(result);</div><div class="line">      &#125;,<span class="attr">error</span> : <span class="function"><span class="keyword">function</span>(<span class="params">result</span>)</span>&#123;</div><div class="line">      <span class="built_in">console</span>.log(result);</div><div class="line">      &#125;</div><div class="line">   &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>进行数据库操作删除如下：<br><figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="meta">@main.route('/d',methods=['POST'])</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">deletecomment</span><span class="params">()</span>:</span></div><div class="line">    jsonData = request.get_json()</div><div class="line">    id=int(jsonData[<span class="string">'id'</span>])</div><div class="line">    comment=BookComment.query.filter_by(id=id).first()</div><div class="line">    db.session.delete(comment)</div><div class="line">    db.session.commit()</div><div class="line">    <span class="keyword">return</span> <span class="string">'ok'</span> <span class="comment">#任意值均可</span></div></pre></td></tr></table></figure></p>
<h2 id="添加、删除成功之后进行消息提示"><a href="#添加、删除成功之后进行消息提示" class="headerlink" title="添加、删除成功之后进行消息提示"></a>添加、删除成功之后进行消息提示</h2><p>在此，实现的方法具有一定的缺陷，执行添加、删除操作之后，便默认执行成功，进行消息提示。<br>其实应该，若对数据库的操作产生异常，应当进行下一步的处理。由于时间原因，便忽略掉对异常的处理。<br>使用<code>Bootstrap</code>的<a href="https://www.w3schools.com/bootstrap/bootstrap_modal.asp" target="_blank" rel="external">Modal</a>对用户进行提醒<br><img src="/img/del.png" alt="del"><br>点击关闭按钮后，执行函数<code>location.reload()</code>对页面进行刷新显示<br><img src="/img/update.png" alt="update"></p>
</div></article></div></main><footer><div class="paginator"><a href="/2018/05/26/数据库课程设计/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2018 <a href="http://Persuingsdu.github.io">Persuing</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>